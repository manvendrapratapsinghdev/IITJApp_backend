{
	"info": {
		"_postman_id": "apple-signin-collection-2026",
		"name": "Apple Sign-In Flow - Student Network App",
		"description": "Complete Apple Sign-In authentication flow with OTP email verification. This collection covers all scenarios: first login with email shared, first login with email hidden (Hide My Email), subsequent logins, and email verification via OTP.",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "Health Check",
			"request": {
				"method": "GET",
				"header": [],
				"url": {
					"raw": "{{base_url}}/api/health",
					"host": [
						"{{base_url}}"
					],
					"path": [
						"api",
						"health"
					]
				},
				"description": "Check if the API server is running and healthy."
			},
			"response": []
		},
		{
			"name": "Scenario 1: First Login - Email Shared (Direct Login)",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"// Parse the response JSON",
							"const response = pm.response.json();",
							"console.log(\"‚úÖ Apple Auth Response:\", response);",
							"",
							"// If account created/logged in successfully, save token",
							"if (pm.response.code === 200 && response.token && response.user) {",
							"    pm.environment.set(\"auth_token\", response.token);",
							"    pm.environment.set(\"user_id\", response.user.id);",
							"    pm.environment.set(\"user_email\", response.user.email);",
							"    pm.environment.set(\"apple_user_id\", response.user.apple_user_id);",
							"    console.log(\"‚úÖ Success! Auth token saved:\", response.token);",
							"    console.log(\"‚úÖ User ID:\", response.user.id);",
							"    console.log(\"‚úÖ User Email:\", response.user.email);",
							"} else if (response.requires_email_verification) {",
							"    console.log(\"‚ö†Ô∏è Email verification required\");",
							"    if (response.user && response.user.apple_user_id) {",
							"        pm.environment.set(\"apple_user_id\", response.user.apple_user_id);",
							"        console.log(\"üìù Apple User ID saved for verification:\", response.user.apple_user_id);",
							"    }",
							"}",
							""
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"auth": {
					"type": "noauth"
				},
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"apple_user_id\": \"001234.abcd1234efgh5678\",\n    \"email\": \"g24test123@iitj.ac.in\",\n    \"email_verified\": true,\n    \"is_private_email\": false,\n    \"name\": {\n        \"firstName\": \"John\",\n        \"lastName\": \"Doe\"\n    }\n}"
				},
				"url": {
					"raw": "{{base_url}}/api/auth/apple",
					"host": [
						"{{base_url}}"
					],
					"path": [
						"api",
						"auth",
						"apple"
					]
				},
				"description": "**Scenario 1: First time Apple Sign-In with email shared**\n\nUser signs in with Apple and chooses to share their real email address.\n\n**What happens:**\n- Apple provides: apple_user_id, email (real IIT email), name, email_verified=true\n- If email is valid IIT email (@iitj.ac.in) with G24 prefix, account is created immediately\n- No OTP verification needed since Apple already verified the email\n- Returns auth token for immediate login\n\n**Request Body:**\n- `apple_user_id`: Unique identifier from Apple (e.g., \"001234.abcd1234efgh5678\")\n- `email`: User's real IIT email (must be @iitj.ac.in with G24 prefix)\n- `email_verified`: true (verified by Apple)\n- `is_private_email`: false (real email, not Hide My Email)\n- `name`: Object with firstName and lastName\n\n**Expected Response (200):**\n```json\n{\n  \"token\": \"jwt_token_here\",\n  \"user\": {\n    \"id\": 1,\n    \"apple_user_id\": \"001234.abcd1234efgh5678\",\n    \"email\": \"g24test123@iitj.ac.in\",\n    \"name\": \"John Doe\",\n    \"email_verified\": true,\n    \"is_onboarding_done\": false\n  },\n  \"is_first_time\": true\n}\n```"
			},
			"response": []
		},
		{
			"name": "Scenario 2: First Login - Email Hidden (Requires Verification)",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"// Parse the response JSON",
							"const response = pm.response.json();",
							"console.log(\"‚ö†Ô∏è Apple Auth Response (Email Hidden):\", response);",
							"",
							"// Save apple_user_id for email verification flow",
							"if (response.requires_email_verification && response.user) {",
							"    pm.environment.set(\"apple_user_id\", response.user.apple_user_id);",
							"    pm.environment.set(\"temp_user_name\", response.user.name);",
							"    console.log(\"üìù Apple User ID saved:\", response.user.apple_user_id);",
							"    console.log(\"üìù Name saved:\", response.user.name);",
							"    console.log(\"‚ö†Ô∏è Email hidden by Apple. Proceed to Step 3: Send OTP\");",
							"}",
							""
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"auth": {
					"type": "noauth"
				},
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"apple_user_id\": \"009876.xyz789abc\",\n    \"email\": \"abc123@privaterelay.appleid.com\",\n    \"email_verified\": true,\n    \"is_private_email\": true,\n    \"name\": {\n        \"firstName\": \"Jane\",\n        \"lastName\": \"Smith\"\n    }\n}"
				},
				"url": {
					"raw": "{{base_url}}/api/auth/apple",
					"host": [
						"{{base_url}}"
					],
					"path": [
						"api",
						"auth",
						"apple"
					]
				},
				"description": "**Scenario 2: First time Apple Sign-In with Hide My Email**\n\nUser signs in with Apple and chooses \"Hide My Email\" option.\n\n**What happens:**\n- Apple provides: apple_user_id, privaterelay email, name, is_private_email=true\n- Server detects private email and requires manual IIT email verification\n- User must provide their real IIT email and verify it via OTP\n- Returns temporary user data and requires_email_verification flag\n\n**Request Body:**\n- `apple_user_id`: Unique identifier from Apple\n- `email`: Apple's private relay email (e.g., abc123@privaterelay.appleid.com)\n- `email_verified`: true (Apple verified their proxy email)\n- `is_private_email`: true (indicates Hide My Email is used)\n- `name`: Object with firstName and lastName\n\n**Expected Response (200):**\n```json\n{\n  \"requires_email_verification\": true,\n  \"user\": {\n    \"apple_user_id\": \"009876.xyz789abc\",\n    \"name\": \"Jane Smith\"\n  },\n  \"message\": \"Please verify your IIT email to complete registration\"\n}\n```\n\n**Next Steps:**\n1. Run \"Step 3: Send OTP\" with real IIT email\n2. Check email for 6-digit OTP code\n3. Run \"Step 4: Verify OTP\" to complete registration"
			},
			"response": []
		},
		{
			"name": "Step 3: Send Verification OTP",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"const response = pm.response.json();",
							"console.log(\"üìß OTP Send Response:\", response);",
							"",
							"if (response.success) {",
							"    console.log(\"‚úÖ OTP sent successfully!\");",
							"    console.log(\"üìß Check email:\", pm.request.body.raw ? JSON.parse(pm.request.body.raw).email : 'unknown');",
							"    console.log(\"‚è∞ OTP expires in:\", response.expires_in, \"seconds (10 minutes)\");",
							"    console.log(\"‚û°Ô∏è Next: Check email and use OTP in Step 4\");",
							"} else {",
							"    console.log(\"‚ùå Failed to send OTP:\", response.error);",
							"}",
							""
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"auth": {
					"type": "noauth"
				},
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"email\": \"g24ait2163@iitj.ac.in\"\n}"
				},
				"url": {
					"raw": "{{base_url}}/api/send-verification-otp",
					"host": [
						"{{base_url}}"
					],
					"path": [
						"api",
						"send-verification-otp"
					]
				},
				"description": "**Step 3: Send OTP to IIT Email**\n\nSends a 6-digit verification code to the user's IIT email address.\n\n**When to use:**\n- After Scenario 2 (Hide My Email) when email verification is required\n- User must provide their real IIT email (@iitj.ac.in with G24 prefix)\n\n**Request Body:**\n- `email`: Real IIT email address (must be @iitj.ac.in and start with G24)\n\n**Validations:**\n- Email must be valid format\n- Email must be @iitj.ac.in domain\n- Email must start with 'G24' prefix\n- Rate limited to 10 requests per hour per email\n\n**Expected Response (200):**\n```json\n{\n  \"success\": true,\n  \"message\": \"Verification code sent to g24ait2163@iitj.ac.in\",\n  \"expires_in\": 600\n}\n```\n\n**OTP Details:**\n- 6-digit numeric code\n- Valid for 10 minutes\n- Maximum 3 verification attempts per OTP\n- Rate limited to prevent abuse\n\n**After sending:**\n1. Check your IIT email inbox (and spam folder)\n2. Copy the 6-digit OTP code from the email\n3. Use it in Step 4 within 10 minutes"
			},
			"response": []
		},
		{
			"name": "Step 4: Verify OTP & Complete Registration",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"const response = pm.response.json();",
							"console.log(\"‚úÖ Verification Response:\", response);",
							"",
							"// Set environment variables if verification is successful",
							"if (pm.response.code === 200 && response.token && response.user) {",
							"    pm.environment.set(\"auth_token\", response.token);",
							"    pm.environment.set(\"user_id\", response.user.id);",
							"    pm.environment.set(\"user_email\", response.user.email);",
							"    console.log(\"‚úÖ Email verified successfully!\");",
							"    console.log(\"‚úÖ Auth token saved:\", response.token);",
							"    console.log(\"‚úÖ User ID:\", response.user.id);",
							"    console.log(\"‚úÖ Apple Sign-In completed!\");",
							"} else {",
							"    console.log(\"‚ùå Verification failed:\", response.error);",
							"    if (response.attempts_remaining) {",
							"        console.log(\"‚ö†Ô∏è Attempts remaining:\", response.attempts_remaining);",
							"    }",
							"}",
							""
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"auth": {
					"type": "noauth"
				},
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"email\": \"g24ait2163@iitj.ac.in\",\n    \"otp\": \"123456\",\n    \"apple_user_id\": \"{{apple_user_id}}\",\n    \"name\": \"Jane Smith\"\n}"
				},
				"url": {
					"raw": "{{base_url}}/api/verify-email-apple-signin",
					"host": [
						"{{base_url}}"
					],
					"path": [
						"api",
						"verify-email-apple-signin"
					]
				},
				"description": "**Step 4: Verify OTP and Complete Apple Sign-In**\n\nVerifies the OTP code and completes the Apple Sign-In registration process.\n\n**When to use:**\n- After receiving OTP via email (Step 3)\n- To complete registration when email was hidden (Scenario 2)\n\n**Request Body:**\n- `email`: The IIT email address used in Step 3\n- `otp`: The 6-digit code received via email\n- `apple_user_id`: Use {{apple_user_id}} from environment (saved in Step 2)\n- `name`: User's full name from Apple Sign-In\n\n**Validations:**\n- All fields are required\n- Email must be valid format\n- OTP must be 6 digits\n- OTP must match and not be expired\n- Maximum 3 verification attempts\n\n**Expected Response (200):**\n```json\n{\n  \"token\": \"jwt_token_here\",\n  \"user\": {\n    \"id\": 2,\n    \"apple_user_id\": \"009876.xyz789abc\",\n    \"email\": \"g24ait2163@iitj.ac.in\",\n    \"name\": \"Jane Smith\",\n    \"email_verified\": true,\n    \"is_onboarding_done\": false\n  },\n  \"is_first_time\": true,\n  \"message\": \"Registration completed successfully\"\n}\n```\n\n**Error Responses:**\n- Invalid OTP: `{\"error\": \"Invalid verification code\", \"attempts_remaining\": 2}`\n- Expired OTP: `{\"error\": \"Verification code expired\"}`\n- Too many attempts: `{\"error\": \"Too many failed attempts\"}` (429)\n- Email already registered: `{\"error\": \"This email is already associated with another Apple account\"}` (409)\n\n**After successful verification:**\n- Account is created and linked to Apple ID\n- Email is marked as verified\n- Auth token is issued for immediate login\n- User can proceed to onboarding"
			},
			"response": []
		},
		{
			"name": "Scenario 3: Subsequent Login (Existing User)",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"const response = pm.response.json();",
							"console.log(\"‚úÖ Login Response:\", response);",
							"",
							"// Save token if login successful",
							"if (pm.response.code === 200 && response.token && response.user) {",
							"    pm.environment.set(\"auth_token\", response.token);",
							"    pm.environment.set(\"user_id\", response.user.id);",
							"    pm.environment.set(\"user_email\", response.user.email);",
							"    console.log(\"‚úÖ Logged in successfully!\");",
							"    console.log(\"‚úÖ Auth token:\", response.token);",
							"    console.log(\"‚úÖ User ID:\", response.user.id);",
							"} else if (response.requires_email_verification) {",
							"    console.log(\"‚ö†Ô∏è Account exists but email not verified yet\");",
							"    console.log(\"‚ö†Ô∏è Complete email verification first\");",
							"} else {",
							"    console.log(\"‚ùå Login failed:\", response.error);",
							"}",
							""
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"auth": {
					"type": "noauth"
				},
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"apple_user_id\": \"001234.abcd1234efgh5678\"\n}"
				},
				"url": {
					"raw": "{{base_url}}/api/auth/apple",
					"host": [
						"{{base_url}}"
					],
					"path": [
						"api",
						"auth",
						"apple"
					]
				},
				"description": "**Scenario 3: Subsequent Apple Sign-In (Returning User)**\n\nUser who has already completed registration signs in again with Apple.\n\n**What happens:**\n- Apple only provides apple_user_id on subsequent logins (no email or name)\n- Server looks up user by apple_user_id\n- If user exists and email is verified, returns auth token immediately\n- If email not verified yet, prompts to complete verification\n\n**Request Body:**\n- `apple_user_id`: Unique identifier from Apple (same as used during registration)\n\n**Expected Response - Success (200):**\n```json\n{\n  \"token\": \"jwt_token_here\",\n  \"user\": {\n    \"id\": 1,\n    \"apple_user_id\": \"001234.abcd1234efgh5678\",\n    \"email\": \"g24test123@iitj.ac.in\",\n    \"name\": \"John Doe\",\n    \"email_verified\": true,\n    \"is_onboarding_done\": true\n  },\n  \"is_first_time\": false,\n  \"action_taken\": \"login\"\n}\n```\n\n**Expected Response - Email Not Verified (200):**\n```json\n{\n  \"requires_email_verification\": true,\n  \"user\": {\n    \"apple_user_id\": \"001234.abcd1234efgh5678\",\n    \"name\": \"John Doe\"\n  },\n  \"message\": \"Please complete email verification\"\n}\n```\n\n**Expected Response - User Not Found (404):**\n```json\n{\n  \"error\": \"Account not found\",\n  \"message\": \"No account found with this Apple ID\"\n}\n```\n\n**Use Cases:**\n- Regular login for existing users\n- Works even if user chose \"Hide My Email\" during first sign-in\n- Fast login with just apple_user_id"
			},
			"response": []
		},
		{
			"name": "Get Current User (After Login)",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"const response = pm.response.json();",
							"console.log(\"üë§ Current User:\", response);",
							"",
							"if (response.user) {",
							"    console.log(\"‚úÖ User ID:\", response.user.id);",
							"    console.log(\"‚úÖ Name:\", response.user.name);",
							"    console.log(\"‚úÖ Email:\", response.user.email);",
							"    console.log(\"‚úÖ Email Verified:\", response.user.email_verified);",
							"    console.log(\"‚úÖ Onboarding Done:\", response.user.is_onboarding_done);",
							"}",
							""
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Authorization",
						"value": "Bearer {{auth_token}}",
						"type": "text"
					}
				],
				"url": {
					"raw": "{{base_url}}/api/users/me",
					"host": [
						"{{base_url}}"
					],
					"path": [
						"api",
						"users",
						"me"
					]
				},
				"description": "**Get Current User Profile**\n\nRetrieves the authenticated user's profile information.\n\n**Authentication:**\n- Requires valid auth token in Authorization header\n- Token is automatically added from environment variable\n\n**Expected Response (200):**\n```json\n{\n  \"user\": {\n    \"id\": 1,\n    \"name\": \"John Doe\",\n    \"email\": \"g24test123@iitj.ac.in\",\n    \"apple_user_id\": \"001234.abcd1234efgh5678\",\n    \"email_verified\": true,\n    \"is_onboarding_done\": false,\n    \"role\": \"user\",\n    \"created_at\": \"2026-01-07 22:00:00\"\n  }\n}\n```\n\n**Use this to:**\n- Verify login was successful\n- Check if email is verified\n- Check if onboarding is completed\n- Get user details for UI display"
			},
			"response": []
		},
		{
			"name": "Logout",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"const response = pm.response.json();",
							"console.log(\"üëã Logout Response:\", response);",
							"",
							"if (response.message === \"Logged out successfully\") {",
							"    // Clear environment variables",
							"    pm.environment.unset(\"auth_token\");",
							"    pm.environment.unset(\"user_id\");",
							"    pm.environment.unset(\"user_email\");",
							"    pm.environment.unset(\"apple_user_id\");",
							"    console.log(\"‚úÖ Logged out successfully!\");",
							"    console.log(\"üßπ Environment variables cleared\");",
							"}",
							""
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Authorization",
						"value": "Bearer {{auth_token}}",
						"type": "text"
					}
				],
				"url": {
					"raw": "{{base_url}}/api/auth/logout",
					"host": [
						"{{base_url}}"
					],
					"path": [
						"api",
						"auth",
						"logout"
					]
				},
				"description": "**Logout**\n\nLogs out the current user by invalidating their auth token.\n\n**Authentication:**\n- Requires valid auth token in Authorization header\n\n**Expected Response (200):**\n```json\n{\n  \"message\": \"Logged out successfully\"\n}\n```\n\n**What happens:**\n- Auth token is invalidated on server\n- User must login again to get new token\n- Environment variables are cleared\n\n**Security Note:**\n- Always logout users properly in production apps\n- Clear local storage/secure storage on client side"
			},
			"response": []
		}
	],
	"event": [
		{
			"listen": "prerequest",
			"script": {
				"type": "text/javascript",
				"exec": [
					""
				]
			}
		},
		{
			"listen": "test",
			"script": {
				"type": "text/javascript",
				"exec": [
					""
				]
			}
		}
	],
	"variable": [
		{
			"key": "base_url",
			"value": "http://localhost:8000",
			"type": "string"
		}
	]
}
